From 8410c9147ad7117e07010b9fbc44337de8e44f89 Mon Sep 17 00:00:00 2001
From: Damien Crier <damien.crier@camptocamp.com>
Date: Fri, 5 Jan 2018 14:15:06 +0100
Subject: [PATCH] sub aa renaming odoo10

---
 sale_contract/models/sale_subscription.py       |  2 +-
 website_contract/models/sale_order.py           |  5 ++++-
 website_contract/tests/test_website_contract.py | 19 +++++++++++++++++++
 3 files changed, 24 insertions(+), 2 deletions(-)

diff --git a/sale_contract/models/sale_subscription.py b/sale_contract/models/sale_subscription.py
index 7395dd9..4a05d42 100644
--- a/sale_contract/models/sale_subscription.py
+++ b/sale_contract/models/sale_subscription.py
@@ -103,7 +103,7 @@ class SaleSubscription(models.Model):
     @api.model
     def create(self, vals):
         vals['code'] = vals.get('code') or self.env.context.get('default_code') or self.env['ir.sequence'].next_by_code('sale.subscription') or 'New'
-        if vals.get('name', 'New') == 'New':
+        if vals.get('name', 'New') == 'New' and not vals.get('analytic_account_id'):
             vals['name'] = vals['code']
         return super(SaleSubscription, self).create(vals)
 
diff --git a/website_contract/models/sale_order.py b/website_contract/models/sale_order.py
index 960af4b..609f859 100644
--- a/website_contract/models/sale_order.py
+++ b/website_contract/models/sale_order.py
@@ -51,7 +51,10 @@ class SaleOrder(models.Model):
                 and any(self.order_line.mapped('product_id').mapped('recurring_invoice')):
             values = self._prepare_contract_data(payment_token_id=payment_token.id if self.require_payment else False)
             subscription = self.env['sale.subscription'].sudo().create(values)
-            subscription.name = self.partner_id.name + ' - ' + subscription.code
+            partner_name = self.partner_id.name or self.partner_id.parent_id.name
+            # Avoid renaming an existing AA
+            if not values.get('analytic_account_id'):
+                subscription.name = self.partner_id.name + ' - ' + subscription.code
 
             invoice_line_ids = []
             for line in self.order_line:
diff --git a/website_contract/tests/test_website_contract.py b/website_contract/tests/test_website_contract.py
index 5219f57..c7af2f8 100644
--- a/website_contract/tests/test_website_contract.py
+++ b/website_contract/tests/test_website_contract.py
@@ -66,5 +66,24 @@ class TestContract(TestContractCommon):
 
         order.onchange_template_id()
         order.action_confirm()
+        self.assertEqual(order.project_id.name, '%s - %s' % (order.partner_id.name, order.subscription_id.code), 'website_contract: analytic account created along subscription should be named as <Subscription code> - <Partner name>')
         self.assertTrue(order.subscription_id, 'website_contract: subscription is not created at so confirmation')
         self.assertEqual(order.subscription_management, 'create', 'website_contract: subscription creation should set the so to "create"')
+
+
+    def test_no_aa_renaming(self):
+        initial_aa_name = 'InitialName'
+        analytic = self.env['account.analytic.account'].create({
+            'partner_id': self.user_portal.partner_id.id,
+            'name': initial_aa_name
+        })
+        order = self.env['sale.order'].create({
+            'name': 'TestSOTemplate',
+            'partner_id': self.user_portal.partner_id.id,
+            'template_id': self.quote_template.id,
+            'project_id': analytic.id,
+        })
+
+        order.onchange_template_id()
+        order.action_confirm()
+        self.assertEqual(analytic.name, initial_aa_name, 'website_contract: subscription creation should not rename an existing AA')
-- 
2.7.4

